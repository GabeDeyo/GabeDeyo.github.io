<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Advanced Scripting - Prefabs</title>

    <meta name="viewport" content="width=device-width,initial-scale=1.0, shrink-to-fit=no" />

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/page.css">
</head>

<body>

    <!-- Top Navigation -->
    <header>
        <nav class="navbar navbar-inverse">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#collapsemenu" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a href="../index.html" class="navbar-brand">Personal Notes</a>
                </div>

                <div class="collapse navbar-collapse" id="collapsemenu">
                    <ul class="nav navbar-nav">

                        <!-- GAME DEVELOMENT -->
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Game Development <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <!-- CONCEPTS -->
                                <li><a href="concepts.html">Concepts <span class="glyphicon-chevron-right"></span></a></li>

                                <!-- ENGINE -->
                                <li><a href="engine.html">Engine <span class="glyphicon-chevron-right"></span></a></li>

                                <!-- IMPLEMENTATIONS -->
                                <li><a href="implementations.html">Implementations <span class="glyphicon-chevron-right"></span></a></li>
                            </ul>
                        </li>

                        <!-- PROGRAMMING -->
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Programming <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <!-- ALGORITHMS -->
                                <li><a href="../code/algorithms.html">Algorithms <span class="glyphicon-chevron-right"></span></a></li>

                                <!-- PROBLEMS -->
                                <li><a href="../code/problems.html">Problems <span class="glyphicon-chevron-right"></span></a></li>

                                <!-- RANDOM -->
                                <li><a href="../code/random.html">Random <span class="glyphicon-chevron-right"></span></a></li>
                            </ul>
                        </li>

                        <!-- GABE DEVELOPMENT -->
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Gabe Development <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <!-- FITNESS PAGE -->
                                <li><a href="../gabe/fitness.html">Fitness <span class="glyphicon-chevron-right"></span></a></li>

                                <!-- STYLE & GROOMING PAGE -->
                                <li><a href="../gabe/style.html">Style <span class="glyphicon-chevron-right"></span></a></li>

                                <!-- FINANCE PAGE -->
                                <li><a href="../gabe/finance.html">Finance <span class="glyphicon-chevron-right"></span></a></li>

                                <!-- PHILOSOPHY PAGE -->
                                <li><a href="../gabe/philosophy.html">Philosophy <span class="glyphicon-chevron-right"></span></a></li>
                            </ul>
                        </li>

                    </ul>
                </div>

            </div>
        </nav>
    </header>

    <!-------------------------------------------------------------------------->

    <!-- MAIN -->
    <main>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1 id="title">Advanced Scripting - Prefabs</h1>

                    <aside>
                        <button type="button" class="btn btn-default" name="button" id="selectAll">Select All</button>
                        <button type="button" class="btn btn-default" name="button" id="clearAll">Clear All</button>
                    </aside>

                    <div class="jumbotron heliList">
                        <h2>Index</h2>
                        <ul>
                            <li><p><span class="glyphicon-remove"></span>
                                <a href="#1">Creating a Prefab System</a>
                                </p>
                            </li>
                            <li><p><span class="glyphicon-remove"></span>
                                <a href="#2">Advanced Prefab System</a>
                                </p>
                            </li>
                        </ul>
                    </div>

<div class="jumbotron col-md-12 heliList" id="1">
    <h2>Creating a Prefab System</h2>
    <ul>
        <li><p><span class="glyphicon-remove"></span>
            In this section, we'll be discussing how to create your own Prefab system for increased control over entity data. This will allow the end user, the gamer, to be able to create their own entities and mod your game. Unity prefabs are a very useful tool, allowing us to define complex entities, save them, and then load them as many times as we want, during the execution of the code. While it is very easy and powerful to create new prefabs in the Editor, it does restrict us to the Editor. This becomes a significant problem if, for example we wanted to allow end users to create their own entities in game.
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            As modding becomes a more common and popular new feature in modern games, it's important to consider how we might enable end user content creation. You can do this with data files that define the state of entities we want to create. This is essentially how Unity creates prefabs using serilization. However, the serialized data generated by Unity Prefabs is not easily accessible to us, or the end user. In order to create our own Prefab system, we're going to need to find our own scripting language. I've created a very simple scripting language here that has a keyword, colon, and data, and in this case, the custom component takes the name of the custom component and the data that will go into the component.
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            Check out this data file: <b>TestEntityA.data</b>
            <pre>
            <span class="glyphicon-remove"></span>position:3,0,1

            customcomponent:AttackInfo

            453.52
            We can define whatever we want here!
            </pre>
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            In order to create our own entities, we need to create an object, add components and then set those component values. For this, we've created the Entity Loader. This is the MonoBehavior that on start will read each file that ends with .data inside of the directory we defined. It will read all the lines of that data file into an array, get the name of the data file, and then create a new Custom Prefab storing the lines from the data file and the name of the Prefab. This will also handle adding new entities to the scene by pressing the A or B key.
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            First lets check out the Entity Loader:
            <pre>
            <span class="glyphicon-remove"></span>public class EntityLoader : MonoBehavior {
                string dataFolder = @"Assets\";
                Dictionary&lt;string, CustomPrefab&gt; prefabs = new Dictionary&lt;string, CustomPrefab&gt;();

                void Start() {
                    foreach(string dataFile in Directory.GetFiles(dataFolder, "*.data", SearchOption.AllDirectories)) {
                        string[] lines = File.ReadAllLines(dataFile);
                        string name = dataFile.Substring(dataFile, LastIndexOf("\\")+1, dataFile.LstIndexOf(".") - (dataFile.LastIndexOf("\\")+1));
                        prefabs.Add(name, new CustomePrefab(name, lines));
                    }
                }

                void Update() {
                    if(Input.GetKeyDown(KeyCode.A)) {
                        prefabs["TestEntityA"].Instantiate();
                    }
                    if(Input.GetKeyDown(KeyCode.B)) {
                        prefabs["TestEntityB"].Instantiate();
                    }
                }
            }
            </pre>
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            Next we'll need to take a look at the CustomPrefab class. This class will hold the data from the Prefab file as well as the name. 
            <pre>
            <span class="glyphicon-remove"></span>public class CustomPrefab {
                string name;
                string[] dataLines;
                int dataPointer = 0;

                public CustomPrefab(string name, string[] scriptLines) {
                    this.name = name;
                    this.dataLines = scriptLines;
                }

                //Create game object, then parse data file to add components and data.
                public GameObject Instantiate() {
                    //Create an empty game object to work with in this example we'll create a sphere.
                    //However, you can easily define a custom mesh of your own.
                    GameObject go = GameObject.CreatePrimitive(PrimitiveType.Sphere);
                    go.name = name;

                    while(dataPointer < dataLines.Length) {
                        if(dataLines[dataPointer].Length < 1) {
                            dataPointer++; //skip any whitespace
                            continue;
                        }

                        if(dataLines[dataPointer].StartsWith("customcomponent:")) {
                            //Separate the component name from the header
                            string componentName = dataLines[dataPointer].Substring(dataLines[dataPointer].IndexOf(":") + 1);
                            dataPointer++;
                            //Unity uses C# reflection and allows us to simply pass the string name of the script we want to add.
                            CustomComponentBase c = go.AddComponent(componentName) as CustomComponentBase;

                            //This is similar to calling go.AddComponent("ComponentA");
                            while(dataLines[dataPointer].Length < 1) {
                                dataPointer++; // clear any white space after the component token
                            }

                            if(c != null) {
                                //Special Components we want to add should implement the ComponentType class, 
                                //this way we can call our special SetData function
                                //Pass the dataPointer as a reference (ref) so that we'll continue with any modification when we get back here
                                c.SetData(dataLines, ref dataPointer);
                            } else {
                                Debug.Log("Error adding " + componentName + "! Ensure the name is typed correctly.");
                            }
                        } else if(dataLines[dataPointer].StartsWith("position:")) {
                            string vec3Position = dataLines[dataPointer].Substring(dataLines[dataPointer].IndexOf(":") + 1);
                            string[] posComponents = vec3Position.Split(',');
                            go.transform.position = new Vector3(float.Parse(posComponents[0]), float.Parse(posComponents[1]), float.Parse(posComponents[2]));
                            dataPointer++;
                            continue;
                        }
                        // else if(other keywords) {
                        //    //other processing (other mesh, mesh filter, colliders, etc.)
                        // }
                        else {
                            Debug.Log("Lines: `" + dataLines[dataPointer] + "` not recognized as valid token");
                            dataPointer++;
                            continue;
                        }
                    }
                    dataPointer = 0;
                    return go;
                }
            }
            </pre>
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            When calling instantiate we're going to create a game object, set the name, parse the file and look for keywords. And create components and set data. We're going to use a while loop to parse through our dataLines in the file. I'll explain more on that later. Here, we're skipping any white space and here we're going to check for our keyword tokens. For example, the customcomponent keyword or the Position keyword.
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            A customcomponent keyword is used when we're defining our own components. And here we would define position as a Unity built in component. Or if we wanted to add other components like mesh, mesh filter, or any colliders, we would add those below here. Let's follow the execution when we come to a customcomponent. When we're reading a customcomponent, we're going to get the componentName. An attempt to add the componentName, using reflection.
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            The componentName in our data example is going to be, AttackInfo, which we have a class of here:
            <pre>
            <span class="glyphicon-remove"></span>public class AttackInfo : CustomComponentBase {
                public float valueX = 0;
                public string valueString = "test";

                public override void SetData(string[] lines, ref int pointer) {
                    Debug.Log("AttackInfo setting data!");
                    valueX = float.Parse(lines[pointer++]);
                    valueString = lines[pointer++];
                }
            }
            </pre>
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            That's going to be created as a CustomComponentbase, which is an abstract class:
            <pre>
            <span class="glyphicon-remove"></span>public abstract class CustomComponetBase : MonoBehavior {
                public abstract void SetData(string[] lines, ref int pointer);
            }
            </pre>
            <p><span class="glyphicon-remove"></span>We use an abstract class here, so we don't have to define each class individually. We can just use a base class. And then call this SetData method on that base class which will then in turn call the set data overriden method in each of our Custom Components. When setting the data we pass in the dataLines that represent the script file as well as the pointer to where we are in the file. This is because each component sets it's own data.</p>
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            It's going to read the file and increment the pointer. So here we're going to set our valueX and our valueString, and increment the pointer. It's passed in as a reference so that when we get back to the Custom Prefab, the dataPointer is up to date. And this is the reason we use a while loop instead of a for each, because we're incrementing the dataPointer outside of the control of the Custom Prefab. Let's follow the execution when we hit a position keyword. In this case we are going to read the value after the position. We're going to split that string into components using the String Split method.
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            The last pieces we'll need for our Prefab system is our Components and their Data.
            <pre>
            <span class="glyphicon-remove"></span>public class ComponentA : CustomComponentBase {
                public float valueX = 0;
                public string valueString = "test";

                public override void SetData(string[] lines, ref int pointer) {
                    Debug.Log("Component A setting data!");
                    valueX = float.Parse(lines[pointer++]);
                    valueString = lines[pointer++];
                }
            }
            </pre>
            <p><span class="glyphicon-remove"></span>And now our last entity data: TestEntityB.data:</p>
            <pre>
            <span class="glyphicon-remove"></span>position:-3,0,0

            customecomponent:AttackInfo

            55
            This is a string value for componentA
            </pre>
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            We split on comma and then creaate a new position using those components. You can see here that we have a position of 3-0-1. That's x, y, and z. So let's see what this looks like. We hit Play. And now we can either press A or B. And that will create our Test Entities. I can see that we have an attack info component; the value of 55. And this is a string value. and then I'm testing TTA F45352, just as defined in our Script file. 
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            In this section, we've covered creating your own Prefab system to allow for modification by end users. This system relies on a simple scripting language you define. Using the simple token parser, the system is able to generate some reasonably complex objects. Further extensions to the system will allow for parent-child relationships, more support for built in Unity components, and improved error handling. While the basic system can be very powerful, it's not very user-friendly in it's current state. If you plan on implementing a similar system, consider extensive documentation. Or create UI which writes scripts automatically.
        </p></li>
    </ul>
    <a href="#title"><span class="glyphicon-menu-up"></span></a>
</div>

<div class="jumbotron col-md-12 heliList" id="2">
    <h2>Advanced Prefab System</h2>
    <ul>
        <li><p><span class="glyphicon-remove"></span>
            XXX
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            XXX
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            XXX
        </p></li>
    </ul>
    <a href="#title"><span class="glyphicon-menu-up"></span></a>
</div>

                    <!-------------------------------------->
                </div>
            </div>
    </main>

    <!-------------------------------------------------------------------------->

    <!-- FOOTER -->
    <footer class="navbar navbar-inverse navbar-fixed-bottom">
        <nav>
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-sm-6 col-xs-12">
                        <ul>
                            <li>&copy; 2017 <a href="http://www.gabedeyo.com">Gabe Deyo</a></li>
                            <li>|</li>
                            <li><a href="mailto:gabedeyo@gmail.com?subject=Notes">gabedeyo@gmail.com</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </footer>

    <!-- Latest Minified Slim JQuery -->
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script src="../js/selection.js" charset="utf-8"></script>
</body>

</html>

<!-- Section Template

<div class="jumbotron col-md-12 heliList" id="">
    <h2>XXX</h2>
    <ul>
        <li><p><span class="glyphicon-remove"></span>
            XXX
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            XXX
        </p></li>
        <li><p><span class="glyphicon-remove"></span>
            XXX
        </p></li>
    </ul>
    <a href="#title"><span class="glyphicon-menu-up"></span></a>
</div>

-->
